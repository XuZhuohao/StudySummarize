# 深度剖析 Kubernetes



## 1. 课前必读

### 1.1开篇词 | 打通“容器技术”的任督二脉

相似的问题被反复提及，比如：

- 为什么容器里只能跑“一个进程”？
- 为什么我原先一直在用的某个 JVM 参数，在容器里就不好使了？
- 为什么 Kubernetes 就不能固定 IP 地址？
- 容器网络连不通又该如何去 Debug？
- Kubernetes 中 StatefulSet 和 Operator 到底什么区别？PV 和 PVC 这些概念又该怎么用？



**课程分为四大模块：**

- **“白话”容器技术基础**

- **Kubernetes 集群的搭建与实践**
- **容器编排与 Kubernetes 核心特性剖析**
- **Kubernetes 开源社区与生态**



### 1.2 预习篇 · 小鲸鱼大事记（一）：初出茅庐

**PaaS 项目被大家接纳的一个主要原因，就是它提供了一种名叫“应用托管”的能力**

- 最初：租一批 AWS 或者 OpenStack 的虚拟机，然后像以前管理物理服务器那样，用脚本或者手工的方式在这些机器上部署应用
- 云计算服务，比的就是谁能更好地模拟本地服务器环境，能带来更好的“上云”体验
- 接着：PaaS 开源项目的出现
- **像 Cloud Foundry 这样的 PaaS 项目，最核心的组件就是一套应用的打包和分发机制**
- **PaaS 项目最核心的能力：**用来运行应用的隔离环境，或者说“沙盒”，就是所谓的“容器”
- **Docker 镜像** 这一个功能战胜了 Cloud Foundry 容器等其他 Paas 项目
  - 一旦用上了 PaaS，用户就必须为每种语言、每种框架，甚至每个版本的应用维护一个打好的包
  - 明明在本地运行得好好的应用，却需要做很多修改和配置工作才能在 PaaS 里运行起来
  - **Docker 镜像解决的，恰恰就是打包这个根本性的问题**
  - Docker 镜像是直接由一个完整操作系统的所有文件和目录构成的，所以这个压缩包里的内容跟你本地开发和测试环境用的操作系统是完全一样的
  - docker这个压缩包赋予了你一种极其宝贵的能力：本地环境和云端环境的高度一致！

**Docker 项目给 PaaS 世界带来的“降维打击”，其实是提供了一种非常便利的打包机制。这种机制直接打包了应用运行所需要的整个操作系统，从而保证了本地环境和云端环境的高度一致，避免了用户通过“试错”来匹配两种不同运行环境之间差异的痛苦过程。**



**思考题**

> 你是否曾经研发过类似 PaaS 的项目？你碰到过应用打包的问题吗，又是如何解决的呢？



### 1.3 预习篇 · 小鲸鱼大事记（二）：崭露头角

**Docker 项目取得如此高关注的原因**：

- 解决了应用打包和发布这一困扰运维人员多年的技术难题；
- 把一个纯后端的技术概念，通过非常友好的设计和封装，交到了最广大的开发者群体手里。

而 Swarm 项目，是 Docker 公司所有这些努力的关键所在。



### 1.4  预习篇 · 小鲸鱼大事记（三）：群雄并起

- Docker 公司在 2014 年 12 月的 DockerCon 上发布 Swarm
- Docker 收购 **Fig 项目**
  - Fig 项目：第一次提出了**“容器编排”（Container Orchestration）**的概念。
  - **云计算的“编排”（Orchestration）：**它主要是指用户如何通过某些工具或者配置来完成一组虚拟机以及关联资源的定义、配置、创建、删除等工作，然后由云计算平台按照这些指定的逻辑来完成的过程。
  - **Docker时代的编排**：对 Docker 容器的一系列定义、配置和创建动作的管理。
- Fig 项目被收购后改名为 **Compose**
- Mesosphere 公司发布了一个名为 **Marathon 的项目**
  - Mesosphere 的 Mesos 大数据火热时最受欢迎的资源管理项目，也是跟 Yarn 项目杀得难舍难分的实力派选手
  - Mesos 社区拥有超大规模集群的管理经验
  - Mesosphere 公司提出“DC/OS”（数据中心操作系统）
- 2014 年 6 月：Google Kubernetes 项目的诞生



### 1.5 预习篇 · 小鲸鱼大事记（四）：尘埃落定

- 2015 年 6 月 22 日 Docker 公司将 Libcontainer 捐出，并改名为 RunC 项目，交由一个完全中立的基金会管理，然后以 RunC 为依据，大家共同制定一套容器和镜像的标准和规范。**这套标准和规范，就是 OCI（ Open Container Initiative ）**
- **OCI 的提出，意在将容器运行时和镜像的实现从 Docker 项目中完全剥离出来**
- Google、RedHat 等发起了一个名为 **CNCF（Cloud Native Computing Foundation）**的基金会
  - 以 Kubernetes 项目为基础，建立一个由开源基础设施领域厂商主导的、按照独立基金会方式运营的平台级社区，来对抗以 Docker 公司为核心的容器商业生态
  - 确保两件事情:
    - Kubernetes 项目必须能够在容器编排领域取得足够大的竞争优势
    - CNCF 社区必须以 Kubernetes 项目为核心，覆盖足够多的场景
  - 竞争方向：
    - Swarm 擅长的是跟 Docker 生态的无缝集成
    - Mesos 擅长的则是大规模集群的调度与管理
    - Kubernetes 选择的应对方式是：Borg
  - 竞争关系
    - Google、RedHat 联盟成立
    - Mesos 社区与容器技术的关系，更像是“借势”
- 2016 年，Docker 公司放弃现有的 Swarm 项目，将容器编排和集群管理功能全部内置到 Docker 项目当中
- **Kubernetes 的应对策略则是开始在整个社区推进“民主化”架构**
  - API 到容器运行时的每一层，Kubernetes 项目都为开发者暴露出了可以扩展的插件机制
  - 催生的二次创作：
    - 微服务治理项目 Istio
    - 有状态应用部署框架 Operator
    - Rook 这样的开源创业项目
- 2017 年开始
  - Docker 项目的容器运行时部分 Containerd 捐赠给 CNCF 社区
  - Docker 项目改名为 Moby，然后交给社区自行维
- 2017 年 10 月，Docker 公司宣布，将在自己的主打产品 Docker 企业版中内置 Kubernetes 项目，至此编排之争”**落下帷幕**





## 2. 容器技术概念入门篇

### 2.1 白话容器基础（一）：从进程说开去

**容器本身没有价值，有价值的是“容器编排”。**



容器，到底是怎么一回事儿？

> **容器其实是一种沙盒技术**。顾名思义，沙盒就是能够像一个集装箱一样，把你的应用“装”起来的技术。这样，应用与应用之间，就因为有了**边界**而不至于相互干扰；而被装进集装箱的应用，也可以被方便地搬来搬去，这不就是 PaaS 最理想的状态嘛。



#### 2.1.1 边界的实现

**进程：**

- 静态表现： 程序
- 动态表现：计算机里的数据和状态的总和

**容器技术的核心功能，就是通过约束和修改进程的动态表现，从而为其创造出一个“边界”**



**Docker 等大多数 Linux 容器来说**

- **Cgroups 技术**是用来制造约束的主要手段
-  **Namespace 技术**则是用来修改进程视图的主要方法。

